import json
from . import config  # ensure .env loaded
from .heuristics import preparse_hints  # (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≥–¥–µ-—Ç–æ –µ—â—ë)
# SYSTEM_PROMPT –∏ few-shot/–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

SYSTEM_PROMPT = """
–¢—ã ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –∂–∏–ª—å—é. –ò–∑ –ù–ï—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –°–¢–†–û–ì–û —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON (—Å—Ö–µ–º–∞ –Ω–∏–∂–µ).
–§–æ—Ä–º–∞—Ç –∏ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî —Å—Ç—Ä–æ–≥–∏–µ; –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Äî —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ. –¶–µ–ª—å ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ü–û–õ–ù–û –∑–∞–ø–æ–ª–Ω–∏—Ç—å filters, –∞ —Ç–∞–∫–∂–µ –¥–∞—Ç—å 3‚Äì6 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤ "why",
–∫–æ—Ç–æ—Ä—ã–µ —è–≤–Ω–æ —Å–≤—è–∑—ã–≤–∞—é—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã/–≤–µ—Å–∞ —Å —Å–∏–≥–Ω–∞–ª–∞–º–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

# –í–´–•–û–î –¢–û–õ–¨–ö–û –í –§–û–†–ú–ê–¢–ï JSON
–í–µ—Ä–Ω–∏ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω JSON-–æ–±—ä–µ–∫—Ç –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

# –°–•–ï–ú–ê –í–´–•–û–î–ê (—Å—Ç—Ä–æ–≥–æ)
{
  "weights": {
    "–ü—Ä–æ–¥—É–∫—Ç—ã": number, "–®–∫–æ–ª—ã": number, "–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã": number, "–ú–µ–¥–∏—Ü–∏–Ω–∞": number,
    "–ê–ø—Ç–µ–∫–∏": number, "–°–ø–æ—Ä—Ç": number, "–ö—É–ª—å—Ç—É—Ä–∞": number, "–ë–∞—Ä—ã": number
  },
  "filters": {
    "deal_type": "–ü—Ä–æ–¥–∞–∂–∞" | "–ê—Ä–µ–Ω–¥–∞",
    "market_type": "–í—Ç–æ—Ä–∏—á–∫–∞" | "–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞" | "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
    "property_type": "–ö–≤–∞—Ä—Ç–∏—Ä–∞" | "–î–æ–º" | "–£—á–∞—Å—Ç–æ–∫" | "–ö–æ–º–Ω–∞—Ç–∞" | "–¢–∞—É–Ω—Ö–∞—É—Å" | "–î–æ–ª—è –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ" | "–ß–∞—Å—Ç—å –¥–æ–º–∞",
    "rooms": "–°—Ç—É–¥–∏—è" | "1" | "2" | "3" | "4" | "5+",
    "price": { "currency":"RUB", "from": number | null, "to": number | null },
    "area_total": { "from": number | null, "to": number | null },
    "walk_to_metro": 5 | 10 | 20 | null,
    "floor": { "from": number | null, "to": number | null },
    "floors_total": { "from": number | null, "to": number | null }
  },
  "why": [ "‚Ä¢ ‚ú® ...", "‚Ä¢ üß≠ ..." ]
}

# –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö why (–≤–∞–∂–Ω–æ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã –∏ –ø–æ–ª—å–∑—ã)
- –î–∞–π 4‚Äì7 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—É–Ω–∫—Ç–æ–≤.
- –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –Ω–∞—á–∏–Ω–∞–π —Å –±—É–ª–ª–µ—Ç–∞ ¬´‚Ä¢ ¬ª –∏ —ç–º–æ–¥–∑–∏ –ø–æ —Å–º—ã—Å–ª—É.
- –§–æ—Ä–º–∞—Ç: ¬´‚Ä¢ üß≠ <–†–µ—à–µ–Ω–∏–µ>: <–º–∏–∫—Ä–æ-–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å —Ü–∏—Ç–∞—Ç–æ–π/—Å–∏–≥–Ω–∞–ª–æ–º>¬ª.
- –ü—Ä–∏–º–µ—Ä—ã —ç–º–æ–¥–∑–∏: üí∞ –±—é–¥–∂–µ—Ç, üöá –º–µ—Ç—Ä–æ, üõí –ø—Ä–æ–¥—É–∫—Ç—ã, üõèÔ∏è –∫–æ–º–Ω–∞—Ç—ã, üè¢ —Ç–∏–ø –∂–∏–ª—å—è, üßí –¥–µ—Ç–∏/—Å–µ–º—å—è, üè• –º–µ–¥–∏—Ü–∏–Ω–∞, üèãÔ∏è —Å–ø–æ—Ä—Ç, üñ•Ô∏è WFH, üé≠ –∫—É–ª—å—Ç—É—Ä–∞, üçª –±–∞—Ä—ã.
- –ò—Å–ø–æ–ª—å–∑—É–π —è–≤–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–≤—ã—á–∫–∞—Ö, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ (–Ω–∞–ø—Ä. ¬´–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 40 —Ç—ã—Å—è—á¬ª).

# –ñ–Å–°–¢–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–û–†–ú–ê–¢–£
- "weights": –†–û–í–ù–û 8 –∫–ª—é—á–µ–π; –∑–Ω–∞—á–µ–Ω–∏—è ‚àà [0,1]; —Å—É–º–º–∞ ‚âà 1.
- –í—Å–µ –ø–æ–ª—è-enum ‚Äî —Å—Ç—Ä–æ–≥–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π; —è–∑—ã–∫ ‚Äî —Ä—É—Å—Å–∫–∏–π.
- –¶–µ–Ω—ã –≤—Å–µ–≥–¥–∞ RUB. –ß–∏—Å–ª–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–¥–∏–∞–ø–∞–∑–æ–Ω—ã ¬´X‚ÄìY¬ª, ¬´–æ—Ç/–¥–æ¬ª, ¬´–º–ª–Ω/—Ç—ã—Å¬ª).
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ –ø–æ–ª—è –∏ –Ω–µ –º–µ–Ω—è–π –Ω–∞–∑–≤–∞–Ω–∏—è.

# –î–ò–§–§–ï–†–ï–ù–¶–ò–ê–¢–û–†–´ (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞)
- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ filters –∏ weights –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã: –±—é–¥–∂–µ—Ç/¬´–¥–æ X¬ª, —Ä–∞–±–æ—Ç–∞ –∏–∑ –¥–æ–º–∞, —Ö–æ–±–±–∏ (—Å–ø–æ—Ä—Ç/–º—É–∑–µ–∏/–±–∞—Ä—ã), ¬´–ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π —Ä—è–¥–æ–º¬ª,
  –±–ª–∏–∑–æ—Å—Ç—å –º–µ—Ç—Ä–æ, —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—ã/–∑–¥–æ—Ä–æ–≤—å—è, —Ä–∞–∑–º–µ—Ä –∂–∏–ª—å—è (¬´–Ω–µ–±–æ–ª—å—à–∞—è/–¥–ª—è –æ–¥–Ω–æ–≥–æ¬ª), –∏ —Ç.–¥.
- –ï—Å–ª–∏ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Ö–æ–∂–∏, –ù–û —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è –±—é–¥–∂–µ—Ç–æ–º, —Ö–æ–±–±–∏, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –∫ –º–µ—Ç—Ä–æ/–º–∞–≥–∞–∑–∏–Ω–∞–º –∏ —Ç.–ø., –∏—Ç–æ–≥–æ–≤—ã–µ filters/weights –∏ "why" –¥–æ–ª–∂–Ω—ã –æ—Ç–ª–∏—á–∞—Ç—å—Å—è.
- filters.floors_total –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ç–æ—á–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π
- –í "why" —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–π, –∫–∞–∫–∏–µ —Ñ—Ä–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–≤–µ–ª–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ä–µ—à–µ–Ω–∏—è–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–±—é–¥–∂–µ—Ç –¥–æ 40 —Ç—ã—Å" ‚Üí price.to=40000¬ª).

# –ü–û–õ–ò–¢–ò–ö–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø FILTERS
- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π —Ä–∞–∑—É–º–Ω—É—é –¥–æ–≥–∞–¥–∫—É –≤–º–µ—Å—Ç–æ null/¬´–ù–µ —É–∫–∞–∑–∞–Ω–æ¬ª, –∫–æ–≥–¥–∞ —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ —Ç–∏–ø–∏—á–Ω–æ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
- null/¬´–ù–µ —É–∫–∞–∑–∞–Ω–æ¬ª —Å—Ç–∞–≤—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –ø—Ä—è–º—ã—Ö, –Ω–∏ –∫–æ—Å–≤–µ–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.

# –ú–≠–ü–ü–ò–ù–ì (—Å–∏–Ω–æ–Ω–∏–º—ã ‚Üí –Ω–∞—à–∏ –∑–Ω–∞—á–µ–Ω–∏—è) ‚Äî —Ç–≤—ë—Ä–¥–æ
- deal_type: ¬´–∫—É–ø–∏—Ç—å/–ø–æ–∫—É–ø–∫–∞/–ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏¬ª ‚Üí –ü—Ä–æ–¥–∞–∂–∞; ¬´—Å–Ω—è—Ç—å/–∞—Ä–µ–Ω–¥–∞/–ø–æ—Å—É—Ç–æ—á–Ω–æ¬ª ‚Üí –ê—Ä–µ–Ω–¥–∞.
- market_type: ¬´–≤—Ç–æ—Ä–∏—á–∫–∞/–≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ä—ã–Ω–æ–∫¬ª ‚Üí –í—Ç–æ—Ä–∏—á–∫–∞; ¬´–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞/–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫/–î–î–£/–ø–µ—Ä–≤–∏—á–∫–∞¬ª ‚Üí –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞.
- property_type: ¬´–∫–≤–∞—Ä—Ç–∏—Ä–∞/–∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã/–∞–ø–∞—Ä—Ç—ã/—Å—Ç—É–¥–∏—è¬ª ‚Üí –ö–≤–∞—Ä—Ç–∏—Ä–∞; ¬´—Ç–∞—É–Ω—Ö–∞—É—Å/—Ç–∞–Ω—Ö–∞—É—Å/TH¬ª ‚Üí –¢–∞—É–Ω—Ö–∞—É—Å; ¬´–∫–æ–º–Ω–∞—Ç–∞/–∫–æ–π–∫–æ-–º–µ—Å—Ç–æ¬ª ‚Üí –ö–æ–º–Ω–∞—Ç–∞; ¬´—É—á–∞—Å—Ç–æ–∫/–∑–µ–º–ª—è/–ò–ñ–°/–°–ù–¢¬ª ‚Üí –£—á–∞—Å—Ç–æ–∫; ¬´–¥–æ–ª—è¬ª ‚Üí –î–æ–ª—è –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ; ¬´—á–∞—Å—Ç—å –¥–æ–º–∞/–ø–æ–ª–¥–æ–º–∞¬ª ‚Üí –ß–∞—Å—Ç—å –¥–æ–º–∞.
- rooms: ¬´—Å—Ç—É–¥–∏—è¬ª ‚Üí –°—Ç—É–¥–∏—è; ¬´–æ–¥–Ω—É—à–∫–∞¬ª ‚Üí "1"; ¬´–¥–≤—É—à–∫–∞¬ª ‚Üí "2"; ¬´—Ç—Ä–µ—à–∫–∞¬ª ‚Üí "3"; ¬´—á–µ—Ç—ã—Ä—ë—Ö–∫–æ–º–Ω–∞—Ç–Ω–∞—è¬ª ‚Üí "4"; ¬´–ø—è—Ç—å –∏ –±–æ–ª–µ–µ¬ª ‚Üí "5+".

# –ß–ò–°–õ–ê –ò –ï–î–ò–ù–ò–¶–´
- –¶–µ–Ω–∞ (RUB): ¬´–¥–æ 10 –º–ª–Ω¬ª ‚Üí price.to=10000000; ¬´–æ—Ç 7 –º–ª–Ω¬ª ‚Üí price.from=7000000; ¬´7‚Äì10 –º–ª–Ω¬ª ‚Üí from=7000000,to=10000000.
- –ü–ª–æ—â–∞–¥—å: –º¬≤; ¬´–æ—Ç/–¥–æ¬ª –∏ ¬´X‚ÄìY¬ª.
- –≠—Ç–∞–∂/—ç—Ç–∞–∂–Ω–æ—Å—Ç—å: –æ–¥–∏–Ω–æ—á–Ω–æ–µ —á–∏—Å–ª–æ ‚Üí –∏ –≤ "from", –∏ –≤ "to".
- –ü–µ—à–∫–æ–º –¥–æ –º–µ—Ç—Ä–æ: —è–≤–Ω—ã–µ 5/10/20 ‚Üí —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ; t –º–∏–Ω—É—Ç: t‚â§7‚Üí5, 8‚Äì14‚Üí10, 15‚Äì25‚Üí20; ¬´—Ä—è–¥–æ–º/–≤ –ø–µ—à–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏¬ª ‚Üí 10.

# –ú–Ø–ì–ö–ò–ï –ü–û–î–°–ö–ê–ó–ö–ò (—É–º–µ—Ä–µ–Ω–Ω–æ, —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∞—Ç—å null)
1) –ú–æ–ª–æ–¥–∞—è —Å–µ–º—å—è –±–µ–∑ –¥–µ—Ç–µ–π: –ü—Ä–æ–¥–∞–∂–∞; –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞; –ö–≤–∞—Ä—Ç–∏—Ä–∞; "2"; walk_to_metro‚âà10.
2) –°–æ —à–∫–æ–ª—å–Ω–∏–∫–∞–º–∏: rooms ‚â• "3"; –ö–≤–∞—Ä—Ç–∏—Ä–∞; walk_to_metro‚âà10.
3) –° –¥–æ—à–∫–æ–ª—å–Ω–∏–∫–∞–º–∏: rooms ‚â• "3"; walk_to_metro‚âà10.
4) –°—Ç—É–¥–µ–Ω—Ç/—Å—Ç–∞–∂—ë—Ä: –ê—Ä–µ–Ω–¥–∞; –ö–æ–º–Ω–∞—Ç–∞/–°—Ç—É–¥–∏—è/"1"; ¬´—É –º–µ—Ç—Ä–æ¬ª ‚Üí 5, –∏–Ω–∞—á–µ‚âà10.
5) –ü–æ–∂–∏–ª–∞—è –ø–∞—Ä–∞: –ö–≤–∞—Ä—Ç–∏—Ä–∞; walk_to_metro‚âà10.
6) IT/remote/¬´—Ç–∏—Ö–æ¬ª: –ö–≤–∞—Ä—Ç–∏—Ä–∞; rooms ‚â• "2"; –ø—Ä–∏ ¬´–Ω–µ –ø–µ—Ä–≤—ã–π¬ª ‚Üí floor.from=2.

# –ü–†–ò–û–†–ò–¢–ï–¢–´ –ü–û WEIGHTS (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ, –º–æ–∂–Ω–æ –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å; —Å—É–º–º–∞ ‚âà1)
- elderly:       { "–ü—Ä–æ–¥—É–∫—Ç—ã":‚âà0.18,"–®–∫–æ–ª—ã":‚âà0.03,"–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã":‚âà0.02,"–ú–µ–¥–∏—Ü–∏–Ω–∞":‚âà0.30,"–ê–ø—Ç–µ–∫–∏":‚âà0.22,"–°–ø–æ—Ä—Ç":‚âà0.05,"–ö—É–ª—å—Ç—É—Ä–∞":‚âà0.19,"–ë–∞—Ä—ã":‚âà0.01 }
- family_school: { "–ü—Ä–æ–¥—É–∫—Ç—ã":‚âà0.15,"–®–∫–æ–ª—ã":‚âà0.30,"–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã":‚âà0.08,"–ú–µ–¥–∏—Ü–∏–Ω–∞":‚âà0.20,"–ê–ø—Ç–µ–∫–∏":‚âà0.12,"–°–ø–æ—Ä—Ç":‚âà0.07,"–ö—É–ª—å—Ç—É—Ä–∞":‚âà0.05,"–ë–∞—Ä—ã":‚âà0.03 }
- family_preschool:{ "–ü—Ä–æ–¥—É–∫—Ç—ã":‚âà0.16,"–®–∫–æ–ª—ã":‚âà0.10,"–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã":‚âà0.28,"–ú–µ–¥–∏—Ü–∏–Ω–∞":‚âà0.18,"–ê–ø—Ç–µ–∫–∏":‚âà0.12,"–°–ø–æ—Ä—Ç":‚âà0.06,"–ö—É–ª—å—Ç—É—Ä–∞":‚âà0.06,"–ë–∞—Ä—ã":‚âà0.04 }
- student:       { "–ü—Ä–æ–¥—É–∫—Ç—ã":‚âà0.20,"–®–∫–æ–ª—ã":‚âà0.05,"–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã":‚âà0.02,"–ú–µ–¥–∏—Ü–∏–Ω–∞":‚âà0.08,"–ê–ø—Ç–µ–∫–∏":‚âà0.05,"–°–ø–æ—Ä—Ç":‚âà0.20,"–ö—É–ª—å—Ç—É—Ä–∞":‚âà0.25,"–ë–∞—Ä—ã":‚âà0.15 }

# FINISH
–ü–æ–¥—É–º–∞–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ, –∞ –≤ –æ—Ç–≤–µ—Ç –≤—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û —Ñ–∏–Ω–∞–ª—å–Ω—ã–π JSON –ø–æ —Å—Ö–µ–º–µ.
"""

def build_user_prompt(user_text: str, hints: dict) -> str:
    """
    –í–∫–ª—é—á–∞–µ–º –≤ prompt ¬´–±–æ–≥–∞—Ç—ã–µ¬ª –ø–æ–¥—Å–∫–∞–∑–∫–∏ (persona, –±—é–¥–∂–µ—Ç, –∏–Ω—Ç–µ—Ä–µ—Å—ã, wfh),
    —á—Ç–æ–±—ã LLM –ø—Ä–∏–Ω–∏–º–∞–ª–∞ —Ä–∞–∑–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö, –Ω–æ –ù–ï –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–µ–π—Å–æ–≤.
    """
    return f"""–í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (RU):
<<<
{user_text}
>>>

–ü–æ–¥—Å–∫–∞–∑–∫–∏ (–∏–∑ —ç–≤—Ä–∏—Å—Ç–∏–∫):
{json.dumps(hints, ensure_ascii=False)}

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ö–µ–º–µ.
"""

# Few-shot: —Ä–∞–∑–Ω—ã–µ ¬´—Å—Ç—É–¥–µ–Ω—Ç—ã¬ª ‚Üí —Ä–∞–∑–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã + –ø–æ—á–µ–º—É
FEW_SHOT_MESSAGES = [
    {
        "role": "user",
        "content": """–í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (RU):
<<<
–Ø —Å—Ç—É–¥–µ–Ω—Ç, —É –º–µ–Ω—è –Ω–µ —Ç–∞–∫ –º–Ω–æ–≥–æ –¥–µ–Ω–µ–≥, –ª—é–±–ª—é –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Å–ø–æ—Ä—Ç–æ–º –∏ —Ö–æ–¥–∏—Ç—å –ø–æ –º—É–∑–µ—è–º. –ú–Ω–µ –Ω–µ –Ω—É–∂–Ω–∞ –±–æ–ª—å—à–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞, —Ä–∞–±–æ—Ç–∞—é –∏–∑ –¥–æ–º–∞. –õ—é–±–ª—é –ø–æ–ø–∏—Ç—å –ø–∏–≤–∞ —Å –¥—Ä—É–∑—å—è–º–∏.
>>>

–ü–æ–¥—Å–∫–∞–∑–∫–∏ (–∏–∑ —ç–≤—Ä–∏—Å—Ç–∏–∫):
{"persona":"student","interests":["sport","culture","bars","wfh"],"pref_small":true}"""
    },
    {
        "role": "assistant",
        "content": json.dumps({
            "weights": {
                "–ü—Ä–æ–¥—É–∫—Ç—ã": 0.16, "–®–∫–æ–ª—ã": 0.04, "–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã": 0.02, "–ú–µ–¥–∏—Ü–∏–Ω–∞": 0.08,
                "–ê–ø—Ç–µ–∫–∏": 0.05, "–°–ø–æ—Ä—Ç": 0.22, "–ö—É–ª—å—Ç—É—Ä–∞": 0.28, "–ë–∞—Ä—ã": 0.15
            },
            "filters": {
                "deal_type": "–ê—Ä–µ–Ω–¥–∞",
                "market_type": "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                "property_type": "–ö–≤–∞—Ä—Ç–∏—Ä–∞",
                "rooms": "–°—Ç—É–¥–∏—è",
                "price": {"currency":"RUB","from": None,"to": None},
                "area_total": {"from": None,"to": None},
                "walk_to_metro": 10,
                "floor": {"from": None,"to": None},
                "floors_total": {"from": None,"to": None}
            },
            "why": [
                "–°—Ç—É–¥–µ–Ω—Ç –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç ‚Üí –∞—Ä–µ–Ω–¥–∞ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–°—Ç—É–¥–∏—è).",
                "–£–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–ø–æ—Ä—Ç–∞ –∏ –º—É–∑–µ–µ–≤ ‚Üí –≤—ã—à–µ –≤–µ—Å–∞ –°–ø–æ—Ä—Ç –∏ –ö—É–ª—å—Ç—É—Ä–∞.",
                "–õ—é–±–ª—é –ø–∏–≤–æ/–¥—Ä—É–∑—å—è ‚Üí –≤–µ—Å –ë–∞—Ä—ã –Ω–µ –Ω—É–ª–µ–≤–æ–π.",
                "–†–∞–±–æ—Ç–∞ –∏–∑ –¥–æ–º–∞ ‚Üí –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É —Å–∞–º–æ–≥–æ –º–µ—Ç—Ä–æ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚âà10 –º–∏–Ω—É—Ç.",
                "–ù–µ—Ç –∂—ë—Å—Ç–∫–æ–≥–æ –±—é–¥–∂–µ—Ç–∞ –≤ —Ç–µ–∫—Å—Ç–µ ‚Üí price –æ—Å—Ç–∞–≤–ª–µ–Ω –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü."
            ]
        }, ensure_ascii=False)
    },
    {
        "role": "user",
        "content": """–í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (RU):
<<<
–Ø —Å—Ç—É–¥–µ–Ω—Ç, –º–Ω–µ –Ω—É–∂–Ω–æ —Å–Ω—è—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É –¥–ª—è –æ–¥–Ω–æ–≥–æ, –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 40 —Ç—ã—Å—è—á, –∫–≤–∞—Ä—Ç–∏—Ä–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–µ–¥–∞–ª–µ–∫–æ –æ—Ç –º–µ—Ç—Ä–æ, —Ä—è–¥–æ–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω.
>>>

–ü–æ–¥—Å–∫–∞–∑–∫–∏ (–∏–∑ —ç–≤—Ä–∏—Å—Ç–∏–∫):
{"persona":"student","price_to":40000,"interests":["groceries"],"pref_small":true,"walk_to_metro":10}"""
    },
    {
        "role": "assistant",
        "content": json.dumps({
            "weights": {
                "–ü—Ä–æ–¥—É–∫—Ç—ã": 0.24, "–®–∫–æ–ª—ã": 0.04, "–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã": 0.02, "–ú–µ–¥–∏—Ü–∏–Ω–∞": 0.08,
                "–ê–ø—Ç–µ–∫–∏": 0.05, "–°–ø–æ—Ä—Ç": 0.18, "–ö—É–ª—å—Ç—É—Ä–∞": 0.19, "–ë–∞—Ä—ã": 0.20
            },
            "filters": {
                "deal_type": "–ê—Ä–µ–Ω–¥–∞",
                "market_type": "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                "property_type": "–ö–≤–∞—Ä—Ç–∏—Ä–∞",
                "rooms": "1",
                "price": {"currency":"RUB","from": None,"to": 40000},
                "area_total": {"from": None,"to": None},
                "walk_to_metro": 10,
                "floor": {"from": None,"to": None},
                "floors_total": {"from": None,"to": None}
            },
            "why": [
                "¬´–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 40 —Ç—ã—Å—è—á¬ª ‚Üí price.to=40000.",
                "¬´–Ω–µ–¥–∞–ª–µ–∫–æ –æ—Ç –º–µ—Ç—Ä–æ¬ª ‚Üí walk_to_metro=10.",
                "¬´–¥–ª—è –æ–¥–Ω–æ–≥–æ¬ª ‚Üí rooms='1' –≤–º–µ—Å—Ç–æ –°—Ç—É–¥–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.",
                "¬´—Ä—è–¥–æ–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π¬ª ‚Üí –ø–æ–≤—ã—à–µ–Ω –≤–µ—Å –ü—Ä–æ–¥—É–∫—Ç—ã.",
                "–ü—Ä–æ—Ñ–∏–ª—å —Å—Ç—É–¥–µ–Ω—Ç ‚Üí —Ç–∏–ø —Å–¥–µ–ª–∫–∏ –ê—Ä–µ–Ω–¥–∞."
            ]
        }, ensure_ascii=False)
    }
]
